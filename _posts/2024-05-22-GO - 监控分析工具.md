---
layout:     post
title:      GO - ç›‘æ§åˆ†æå·¥å…·
subtitle:   GO - ç›‘æ§åˆ†æå·¥å…·
date:       2024-05-22
author:     SkioFox
header-img: img/post-bg-e2e-ux.jpg
catalog: true
tags:
- pprof
- æ€§èƒ½åˆ†æ
---

# pprofä»‹ç»ä¸ä½¿ç”¨

> pprof æ˜¯ç”¨äºå¯è§†åŒ–å’Œåˆ†ææ€§èƒ½åˆ†ææ•°æ®çš„å·¥å…·

> pprof ä»¥ [profile.proto](https://github.com/google/pprof/blob/master/proto/profile.proto) è¯»å–åˆ†ææ ·æœ¬çš„é›†åˆï¼Œå¹¶ç”ŸæˆæŠ¥å‘Šä»¥å¯è§†åŒ–å¹¶å¸®åŠ©åˆ†ææ•°æ®ï¼ˆæ”¯æŒæ–‡æœ¬å’Œå›¾å½¢æŠ¥å‘Šï¼‰

> profile.proto æ˜¯ä¸€ä¸ª Protocol Buffer v3 çš„æè¿°æ–‡ä»¶ï¼Œå®ƒæè¿°äº†ä¸€ç»„ callstack å’Œ symbolization ä¿¡æ¯ï¼Œ ä½œç”¨æ˜¯è¡¨ç¤ºç»Ÿè®¡åˆ†æçš„ä¸€ç»„é‡‡æ ·çš„è°ƒç”¨æ ˆï¼Œæ˜¯å¾ˆå¸¸è§çš„ stacktrace é…ç½®æ–‡ä»¶æ ¼å¼

---

> ### **runtime.pprofå¼•å…¥pprof**

> ä»¥ä¸‹demoæ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡runtime.pprofå¼•å…¥pprofåˆ†æå†…å­˜çš„ä½¿ç”¨

```other
import (
    "fmt"
    "log"
    "os"
    "runtime/pprof"
    "unsafe"
)

var userDir = os.Getenv("HOME")

func main() {
    // ç”³è¯·2GBçš„å†…å­˜
    b := make([]byte, 1024*1024*1024*2)
    memLeak(*(*[]int)(unsafe.Pointer(&b)))

    memProfile := fmt.Sprintf("%s/%s", userDir, "memProfile")
    f, err := os.Create(memProfile)
    if err != nil {
        log.Fatalln(err)
    }
    defer f.Close()

    err = pprof.WriteHeapProfile(f)
    if err != nil {
        log.Fatalln(err)
    }
    a = nil
}

var a []int

func memLeak(b []int) []int {
    a = b[:2]
    return a
}
```

- åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†runtime.pprofè¿›è¡Œå†…å­˜çš„åˆ†æ
- è¿è¡Œç¨‹åºåæˆ‘ä»¬åˆ©ç”¨pprofåˆ†æå·¥å…·æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ

> `go tool pprof ~/memProfile`

> `go tool pprof <format> [options] [binary] <source> ...`

```other
âœ  ~ go tool pprof memProfile
Type: inuse_space
Time: Jan 23, 2022 at 9:53pm (CST)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof)
```

---

- æˆ‘ä»¬è¿›å…¥åˆ°äº¤äº’å¼ç»ˆç«¯
- topå‘½ä»¤ä¼šåˆ—å‡ºæœ€é«˜çš„å ç”¨é¡¹ï¼Œä¼šæ ¹æ®pprofé»˜è®¤è¿‡æ»¤æƒ…å†µå±•ç¤ºæ•°æ®

`top`

```other
(pprof) top
Showing nodes accounting for 2GB, 99.93% of 2GB total
Dropped 14 nodes (cum <= 0.01GB)
      flat  flat%   sum%        cum   cum%
       2GB 99.93% 99.93%        2GB 99.93%  main.main
         0     0% 99.93%        2GB 99.93%  runtime.main
```

| flat  | å‡½æ•°è¿è¡Œæƒ…å†µ       |
| ----- | ------------ |
| flat% | å‡½æ•°è¿è¡Œæƒ…å†µå æ¯”     |
| sum%  | å‡½æ•°è‡ªèº«ç´¯è®¡å æ¯”     |
| cum   | å‡½æ•°åŠè°ƒç”¨å‡½æ•°æ€»æƒ…å†µ   |
| cum%  | å‡½æ•°è‡ªèº«å ç”¨è¯¥å‡½æ•°çš„å æ¯” |

> å…¶ä¸­ï¼Œpprofå¯¹äºå†…å­˜é»˜è®¤åˆ†æçš„æ˜¯inuse_spaceï¼Œå¸¸ç”¨çš„å‡ ç§ç±»å‹å¦‚ä¸‹

- > inuse_spaceï¼šåˆ†æåº”ç”¨ç¨‹åºçš„å¸¸é©»å†…å­˜å ç”¨æƒ…å†µ
- > alloc_objectsï¼šåˆ†æåº”ç”¨ç¨‹åºçš„å†…å­˜ä¸´æ—¶åˆ†é…æƒ…å†µ
- > inuse_objects: æ¯ä¸ªå‡½æ•°æ‰€åˆ†åˆ«çš„å¯¹è±¡æ•°é‡
- > alloc_space: æŸ¥çœ‹åˆ†é…çš„å†…å­˜ç©ºé—´å¤§å°

---

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ç¨‹åºä¸­ï¼Œå¸¸é©»å†…å­˜çš„å®¹é‡å¤§å°ä¸º2GBï¼Œå‡åˆ†é…åˆ°äº†main.mianå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“2GBåˆ†é…åˆ°äº†å“ªé‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡listå‘½ä»¤æŸ¥çœ‹å†…å­˜åˆ†é…çš„å…·ä½“æƒ…å†µ

`list main.main`

```other
(pprof) list main.main
Total: 2GB
ROUTINE ======================== main.main in /Users/maishuqiang/GolandProjects/ginLearn/main.go
       2GB        2GB (flat, cum) 99.93% of Total
         .          .     10:
         .          .     11:var userDir = os.Getenv("HOME")
         .          .     12:
         .          .     13:func main() {
         .          .     14: // ç”³è¯·2GBçš„å†…å­˜
       2GB        2GB     15: b := make([]byte, 1024*1024*1024*2)
         .          .     16: memLeak(*(*[]int)(unsafe.Pointer(&b)))
         .          .     17:
         .          .     18: memProfile := fmt.Sprintf("%s/%s", userDir, "memProfile")
         .          .     19: f, err := os.Create(memProfile)
         .          .     20: if err != nil {
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨å†…å­˜ä¸­åˆ†é…çš„2GBçš„å†…å­˜ä½¿ç”¨åœ¨äº†ç¬¬15è¡Œ

---

æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡traceså‘½ä»¤æŸ¥çœ‹å‡½æ•°çš„è°ƒç”¨æ ˆä¿¡æ¯

`traces main.main`

```other
(pprof) traces main.main
Type: inuse_space
Time: Jan 23, 2022 at 9:53pm (CST)
-----------+-------------------------------------------------------
     bytes:  2GB
       2GB   main.main
             runtime.main
-----------+-------------------------------------------------------
```

---

> ä»¥ä¸Šäº‹ä¾‹ç»™å‡ºäº†3ç§åœ¨pprofä¸­å¸¸ç”¨çš„åˆ†æå‘½ä»¤

- > topï¼šåˆ—å‡ºæœ€é«˜çš„ä½¿ç”¨æƒ…å†µ
- > listï¼šåˆ—å‡ºå‡½æ•°å…·ä½“çš„ä½¿ç”¨æƒ…å†µ
- > tracesï¼šåˆ—å‡ºå‡½æ•°çš„è°ƒç”¨æ ˆä¿¡æ¯

> æˆ‘ä»¬å¦‚ä½•åˆ†æç¨‹åºçš„goroutineå’Œcpuçš„ä½¿ç”¨æƒ…å†µï¼Ÿ

> é’ˆå¯¹äºä¸Šè¿°çš„ä¾‹å­ï¼Œæˆ‘ä»¬è¦å¦‚ä½•ä¼˜åŒ–è§£å†³å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Ÿ

> ğŸ¤«

---

> ## net/pprofå¼•å…¥pprofçš„ä½¿ç”¨

> å¯¹äºä¸€ä¸ªè¿è¡Œä¸­çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨net/pprofæ¥åˆ†æç¨‹åºçš„è¿è¡Œæƒ…å†µ

> ä»¥ä¸‹ä¾‹å­æˆ‘ä»¬é€šè¿‡net/pprofçš„ä½¿ç”¨æ¥åˆ†ægoroutineçš„æƒ…å†µ

```other
import (
    "encoding/json"
    "log"
    "net/http"
    _ "net/http/pprof"
    "os"
    
    "gorm.io/driver/mysql"
    "gorm.io/gorm"
)

func main() {
    http.HandleFunc("/test", handle)
    if err := http.ListenAndServe(":6060", nil); err != nil {
        return
    }
}

var conn *gorm.DB

func initDB() {
    db, err := gorm.Open(mysql.New(mysql.Config{DSN: os.Getenv("LOCAL_DB")}))
    if err != nil {
        log.Fatalln(err)
    }

    conn = db
}

type T struct {
    Id   uint   `gorm:"primaryKey" json:"id" db:"id"`
    Name string `json:"name"`
    Age  int    `json:"age"`
}

func (t *T) TableName() string {
    return "test1"
}

func getData() (*T, error) {
    initDB()
    t := &T{}
    if err := conn.First(t).Error; err != nil {
        return nil, err
    }
    return t, nil
}

func handle(w http.ResponseWriter, r *http.Request) {
    t, err := getData()
    if err != nil {
        return
    }

    b, _ := json.Marshal(t)
    w.Write(b)
}
```

- ä¸Šè¿°çš„demoä¸­ï¼Œæˆ‘ä»¬è¿æ¥äº†DBè¿›è¡Œæ•°æ®æŸ¥è¯¢å¹¶è¿”å›æ•°æ®
- **æ³¨æ„ï¼šåœ¨ä½¿ç”¨net/pprofçš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è¦æ³¨æ„importä¸­ä½¿ç”¨ _ "net/http/pprof"**

---

æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ç›‘æ§ç•Œé¢

`http://localhost:6060/debug/pprof`

![Image.png](/img/2024-05-20/1.png)

- > å›¾ä¸­è¯´æ˜äº†å„ä¸ªé€‰é¡¹çš„ä¾‹å­ï¼Œè¯¥demoå±•ç¤ºçš„æ˜¯goroutineï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨goroutineçš„æ•°é‡
- > åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå¯ä»¥çœ‹åˆ°goroutineçš„æ•°é‡æ—¶4
- > å½“æˆ‘ä»¬å‘èµ·è¯·æ±‚æ—¶ï¼Œæ³¨æ„æŸ¥çœ‹goroutineçš„å˜åŒ–
- > `http://localhost:6060/test`

![Image.png](/img/2024-05-20/2.png)

å½“æˆ‘ä»¬å‘èµ·äº†å‡ æ¬¡è¯·æ±‚åï¼Œçœ‹åˆ°ç¨‹åºçš„goroutineçš„æ•°é‡ä¸Šå‡åˆ°äº†42ï¼Œæˆ‘ä»¬æƒ³åˆ†æè¿™ä¸Šå‡çš„åç¨‹æ˜¯å¦åˆç†ï¼Œå¹¶ä¸”æƒ³å…·ä½“æŸ¥çœ‹åç¨‹åˆ†é…çš„æƒ…å†µ

---

> **ç‚¹å‡»goroutine**

![Image.png](/img/2024-05-20/3.png)

- > æˆ‘ä»¬ç‚¹å‡»é“¾æ¥åï¼Œçœ‹åˆ°äº†å›¾ä¸­çš„ä¿¡æ¯
- > å…¶ä¸­debug=1æ¨¡å¼ä»‹ç»äº†åç¨‹çš„æ¦‚æ‹¬æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°å¤§å¤šæ•°çš„åç¨‹å‡åœ¨è¿æ¥dbä¸Š
- > debug=2æ¨¡å¼è¯¦ç»†ä»‹ç»äº†æ¯ä¸€ä¸ªåç¨‹çš„å„è‡ªæƒ…å†µï¼ŒæŸ¥çœ‹åˆ°å¤§å¤šæ•°åç¨‹éƒ½é˜»å¡åœ¨äº†selectä¸Š

![Image.png](/img/2024-05-20/4.png)

---

> **æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¼å‡ºåç¨‹åˆ†ææ–‡ä»¶è¿›è¡Œåˆ†æ**

`http://localhost:6060/debug/pprof/goroutine?seconds=10`

- å…¶ä¸­secondså¯ä»¥æŒ‡å®šé‡‡é›†çš„æ—¶é—´
- é‡‡é›†åçš„åˆ†ææ–‡ä»¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¹‹å‰ä»‹ç»çš„å‘½ä»¤å°½å¿ƒåˆ†æ
- `go tool pprof ã€Œåˆ†ææ–‡ä»¶ã€`
- é…åˆtopï¼Œlistï¼Œtracesç­‰å‘½ä»¤æŸ¥çœ‹åç¨‹çš„æƒ…å†µï¼ŒæŸ¥çœ‹åç¨‹å…·ä½“æ³„æ¼åœ¨å“ª

---

> ### go-test pprofåˆ†æ

æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å•å…ƒæµ‹è¯•ä¸­è¿›è¡Œåˆ†æé‡‡æ ·ï¼Œä¸‹é¢å±•ç¤ºä½¿ç”¨go teståˆ†æcpuçš„çš„æƒ…å†µ

```other
// 1 1 2 3 5 ...

const mod int = 1e9 + 7

func fib(i int) int {
    if i <= 2 {
        return 1
    }

    return (fib(i-1) + fib(i-2)) % mod
}

func Benchmark_fib(b *testing.B) {
    for i := 0; i < b.N; i++ {
        fib(30)
    }
}
```

- > æ‰§è¡Œå‘½ä»¤

> `go test -bench=Benchmark_fib -cpuprofile=c1Profile -cpu 1`

- > è·å–åˆ°åˆ†ææ–‡ä»¶åï¼Œæˆ‘ä»¬æ¢å¦ä¸€ç§æ–¹å¼æŸ¥çœ‹åˆ†ææ–‡ä»¶
- > æ‰§è¡Œå‘½ä»¤

> `go tool pprof -http=:6060 c1Profile`

![Image.png](/img/2024-05-20/5.png)

ç¨‹åºä¼šæ‰“å¼€é»˜è®¤æµè§ˆå™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®é€‰æ‹©ä¸åŒçš„æŸ¥çœ‹æ¨¡å¼

> VIEW

![Image.png](/img/2024-05-20/6.png)

- æˆ‘ä»¬å¯ä»¥ç‚¹å‡»Flam GraphæŸ¥çœ‹ç«ç„°å›¾

![Image.png](/img/2024-05-20/7.png)

- PeekæŸ¥çœ‹æŸ¥çœ‹cpuå ç”¨çš„æ¦‚è¿°

![Image.png](/img/2024-05-20/8.png)
- topæŸ¥çœ‹æ¦‚è§ˆï¼ŒGraphä»¥å›¾è¡¨çš„æ–¹å¼å±•ç¤º
- SourceæŸ¥çœ‹å…·ä½“çš„æƒ…å†µ

![Image.png](/img/2024-05-20/9.png)

å¯ä»¥çœ‹åˆ°ç¨‹åºè€—æ—¶ä¸»è¦é›†ä¸­åœ¨14è¡Œä»£ç 

---

## pprofåˆ†ææ–‡ä»¶å¯¹æ¯”

- > ä¸Šè¿°æˆ‘ä»¬ä»‹ç»äº†3ç§pprofçš„ä½¿ç”¨æ–¹å¼ï¼Œå¹¶ä»‹ç»äº†ä¸åŒæ–¹æ³•é‡‡é›†pprofåˆ†ææ–‡ä»¶å’Œåˆ†ææ ·æœ¬
- > ä¸Šè¿°çš„3ä¸ªä¾‹å­ç»™å‡ºäº†cpuï¼Œheapï¼Œgoroutineçš„çš„é‡‡é›†åˆ†æä»‹ç»ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰ä»‹ç»å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå½“ä½œæ€è€ƒç»ƒä¹ 
- > ä¸‹é¢æˆ‘ä»¬é€šè¿‡pprofåˆ†ææ–‡ä»¶çš„å¯¹æ¯”ï¼Œä»¥å…¶ä¸­ä¸€ä¸ªdemoå±•ç¤ºä¼˜åŒ–åçš„åˆ†æä½¿ç”¨
- > ä»¥æœ€åä¸€ä¸ªcpuä¸ºä¾‹

åœ¨cpuçš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ†æåˆ°äº†ç¨‹åºè€—æ—¶çš„ä¸»è¦åŸå› åœ¨äºé€’å½’ä¸­ï¼Œæˆ‘ä»¬æƒ³åŠæ³•å°†é€’å½’è¿›è¡Œä¼˜åŒ–ï¼Œä»£ç å¦‚ä¸‹

```other
// 1 1 2 3 5 ...

const mod int = 1e9 + 7

func fib(n int) int {
    if n < 2 {
        return 1
    }
    pre, cur := 1, 1
    for i := 2; i <= n; i++ {
        res := (pre + cur) % mod
        pre = cur % mod
        cur = res % mod
    }
    return pre
}

func Benchmark_fib(b *testing.B) {
    for i := 0; i < b.N; i++ {
        fib(30)
    }
}
```

- è¿è¡Œ `go test -bench=Benchmark_fib -cpuprofile=c2Profile -cpu 1`
- å•ç‹¬åˆ†æc2Profileåˆ†ææ–‡ä»¶
- è¿™æ¬¡ä½¿ç”¨å‘½ä»¤è¡Œäº¤æ¢çš„å½¢å¼
- è¿è¡Œ `go tool pprof c2Profile`

```other
(pprof) top
Showing nodes accounting for 1590ms, 100% of 1590ms total
      flat  flat%   sum%        cum   cum%
    1070ms 67.30% 67.30%     1070ms 67.30%  m/ginLearn/v2.fib
     460ms 28.93% 96.23%     1590ms   100%  m/ginLearn/v2.Benchmark_fib
      60ms  3.77%   100%       60ms  3.77%  runtime.asyncPreempt
         0     0%   100%     1590ms   100%  testing.(*B).launch
         0     0%   100%     1590ms   100%  testing.(*B).runN
(pprof) list v2.fib
Total: 1.59s
ROUTINE ======================== m/ginLearn/v2.fib in /Users/maishuqiang/GolandProjects/ginLearn/main_test.go
     1.07s      1.07s (flat, cum) 67.30% of Total
         .          .      9:func fib(n int) int {
         .          .     10: if n < 2 {
         .          .     11:  return 1
         .          .     12: }
         .          .     13: pre, cur := 1, 1
     1.07s      1.07s     14: for i := 2; i <= n; i++ {
         .          .     15:  res := (pre + cur) % mod
         .          .     16:  pre = cur % mod
         .          .     17:  cur = res % mod
         .          .     18: }
         .          .     19: return pre
(pprof)
```

- > å•ç‹¬åˆ†æc2Profileå¯ä»¥çœ‹åˆ°èŠ±è´¹çš„æ—¶é—´å‡å°‘äº†å¾ˆå¤š
- > æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹æ¯”ï¼ŒæŸ¥çœ‹å…·ä½“æ—¶é—´å‡å°‘åœ¨å“ª
- > æ‰§è¡Œå‘½ä»¤ `go tool pprof -base c1Profile c2Profile`
- > ä¸Šè¿°å‘½ä»¤è¡¨ç¤ºä»¥c1Profileä¸ºåŸºå‡†ï¼Œc2Profieä¸c1Profileè¿›è¡Œå¯¹æ¯”
- > ä¹Ÿå¯ä»¥ä½¿ç”¨webçš„å½¢å¼æ‰“å¼€
- > `go tool pprof -base -http=:6061 c1Profile c2Profile`

![Image.png](/img/2024-05-20/10.png)

é€šè¿‡ä¼˜åŒ–æˆ‘ä»¬å¯ä»¥æ˜æ˜¾çœ‹åˆ°è€—æ—¶çš„å‡å°‘ï¼Œä»¥åŠå‡å°‘åœ¨å“ª

---

- > ä¸Šè¿°æˆ‘ä»¬ä»‹ç»äº†pprofçš„å‡ ç§ä½¿ç”¨æ–¹å¼ï¼Œä¹Ÿä»‹ç»äº†pprofçš„-baseå¯¹æ¯”ä½¿ç”¨
- > ä¹Ÿç•™ä¸‹äº†ä¸€äº›æ€è€ƒç•™ç»™å¤§å®¶
- > pprofçš„ç®€å•ä»‹ç»åˆ°æ­¤ï¼Œè¿˜æœ‰å¾ˆå¤šå‘½ä»¤æ²¡æœ‰ä»‹ç»ï¼Œå¦‚webå‘½ä»¤ï¼Œæ’åºå‘½ä»¤ï¼Œtreeå‘½ä»¤ç­‰
- > ç›¸ä¿¡é€šè¿‡äº†åŸç”Ÿçš„pprofçš„ä½¿ç”¨ï¼Œjarvisä¸Šçš„åˆ†æå·¥å…·ä¹Ÿä¼šä½¿ç”¨äº†ğŸ¤“
