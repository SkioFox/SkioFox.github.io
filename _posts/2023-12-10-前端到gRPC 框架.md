---
layout:     post
title:      å‰ç«¯åˆ°gRPC æ¡†æ¶
subtitle:   å‰ç«¯åˆ°gRPC æ¡†æ¶
date:       2023-12-10
author:     SkioFox
header-img: img/post-bg-swift2.jpg
catalog: true
tags:
- gRPC
- Node
---

RPC æ˜¯ä»€ä¹ˆï¼Ÿ
--------

RPC è‹±æ–‡å…¨ç§°æ˜¯ Remote Procedure Call æ—¢è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œç»´åŸºç™¾ç§‘ä¸­ç»™çš„å®šä¹‰æ˜¯ä¸€ä¸ªè®¡ç®—æœºè°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°ï¼Œä½†è¿™ä¸ªå‡½æ•°å¹¶ä¸åœ¨è¿™å°è®¡ç®—æœºä¸Šï¼Œè¿™ç§è¿œç¨‹è°ƒç”¨æ–¹å¼ç¨‹åºå‘˜æ— éœ€å…³æ³¨åˆ°åº•æ€ä¹ˆè¿œç¨‹è°ƒç”¨ï¼Œå°±åƒæ˜¯æœ¬åœ°æ‰§è¡Œä¸€ä¸ªå‡½æ•°ä¸€æ¨¡ä¸€æ ·ã€‚

å¬ç€å¾ˆé«˜å¤§ä¸Šï¼Œæˆ‘ä»¬è¦å®ç°ä¸€ä¸ªæ±‚å’Œçš„ä¾‹å­ï¼š

```js
function sum(a, b) {
	return a + b
}
```

ä½œä¸ºå®¢æˆ·ç«¯ï¼Œå®é™…æ˜¯ä¸çŸ¥é“ sum çš„é€»è¾‘çš„ï¼Œå®ƒåªéœ€è¦ä¼ é€’ `a` å’Œ `b` ä¸¤ä¸ªå‚æ•°ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯è¿”å›ç»“æœå³å¯ã€‚

**è¿™é‡Œå¤§å®¶å°±ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿œç¨‹è°ƒä¸€ä¸ªå‡½æ•°ï¼Ÿ**

ç­”æ¡ˆå°±æ˜¯æˆ‘ä»¬æœ¬åœ°æ²¡æœ‰å‘€ï¼Œä¸Šé¢ä¸¾çš„æ˜¯ `sum` çš„çº¯é€»è¾‘ï¼Œä½†å¦‚æœæ˜¯å®¢æˆ·ç«¯æœ‰è´¦å·å’Œå¯†ç ï¼Œè¦è·å– **ç”¨æˆ·è¯¦ç»†ä¿¡æ¯**çš„æ•°æ®å‘¢ï¼Œæˆ‘ä»¬æœ¬åœ°æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥ä¸€å®šè¦è¿œç¨‹è°ƒç”¨ã€‚

RPC å’Œ HTTP åè®®çš„å…³ç³»ï¼Ÿ
-----------------

ç»è¿‡æˆ‘ä»¬ä¸€è§£é‡Šï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰äº›æ˜ç™½äº†ï¼Œä½†åˆä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç–‘é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹æ€ä¹ˆå’Œ http çš„è¯·æ±‚å“åº”æ¨¡å‹è¿™ä¹ˆåƒå‘¢ï¼Œä¸¤è€…æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ å…¶å®å¹¿ä¹‰çš„ç†è§£ä¸­ï¼Œhttp å°±æ˜¯ rpc çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œrpc æ›´å¤šåƒæ˜¯ä¸€ç§æ€æƒ³ï¼Œhttp è¯·æ±‚å’Œå“åº”æ˜¯ä¸€ç§å®ç°ã€‚

gRPC æ˜¯ä»€ä¹ˆï¼Ÿ
---------

åˆšåˆšè¯´äº† rpc æ›´å¤šçš„æ˜¯ä¸€ç§æ€æƒ³ï¼Œè€Œæˆ‘ä»¬ç°åœ¨è¯´çš„ gRPC åˆ™æ˜¯ RPC çš„ä¸€ç§å®ç°ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºä¸€ä¸ªæ¡†æ¶ï¼Œå¹¶ä¸”ä¸æ­¢è¿™ä¸€ä¸ªæ¡†æ¶ï¼Œä¸šç•Œè¿˜æœ‰ `thrift`ï¼Œä½†æ˜¯ç›®å‰å¾®æœåŠ¡ä¸­ç”¨çš„æ¯”è¾ƒå¹¿æ³›çš„å°±æ˜¯å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å­¦ä¹ çš„å°±æ˜¯å®ƒã€‚

gRPC [å®˜ç½‘](https://www.grpc.io/) çš„ä»‹ç»æ˜¯ `A high performance, open source universal RPC frameworkã€‚` ä¸€ä¸ªé«˜æ€§èƒ½ã€å¼€æºçš„é€šç”¨RPCæ¡†æ¶ã€‚å®ƒæœ‰ä»¥ä¸‹å››ä¸ªç‰¹ç‚¹ï¼š

*   æœåŠ¡å®šä¹‰ç®€å•
*   è·¨è¯­è¨€å’Œå¹³å°
*   å¿«é€Ÿæ‰©ç¼©å®¹
*   åŸºäº HTTP/2 çš„åŒå‘è®¤è¯

è§£è¯»ï¼š

*   æœåŠ¡å®šä¹‰ç®€å•ï¼šåŸºäº `Protocol Buffers` å®šä¹‰æœåŠ¡ï¼ˆåé¢ä¼šè®²è§£ï¼‰
*   è·¨è¯­è¨€å’Œå¹³å°ï¼šé€šè¿‡ proto å®šä¹‰å¯ä»¥ç”Ÿæˆå„ä¸ªè¯­è¨€çš„ä»£ç  ğŸ‚

æœ¬æ–‡ä¹Ÿä¸»è¦å›´ç»•ç€ä¸¤ç‚¹ï¼Œé€šè¿‡ç¤ºä¾‹è¿›è¡Œé˜è¿°ã€‚

Protocol Buffer æ˜¯ä»€ä¹ˆï¼Ÿ
--------------------

> VS Code æä¾›äº† `vscode-proto3` è¿™ä¸ªæ’ä»¶ç”¨äº proto çš„é«˜äº®

protocal buffer ä½ å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¯­è¨€ï¼Œä¸è¿‡ä¸ç”¨æ€•ï¼Œå…¶è¯­æ³•æ˜¯ååˆ†çš„ç®€å•ï¼Œå®ƒçš„ä½œç”¨ä¹Ÿå¾ˆæ˜ç¡®ï¼Œå°±æ˜¯ç”¨æ¥å®šä¹‰å‡½æ•°ã€å‡½æ•°çš„å‚æ•°ã€å“åº”ç»“æœçš„ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè½¬ä¸ºä¸åŒè¯­è¨€çš„å‡½æ•°å®ç°ã€‚å…¶åŸºæœ¬è¯­æ³•ä¸ºï¼š

```protobuf
// user.proto

syntax = "proto3";

package user; // åŒ…åç§°

// è¯·æ±‚å‚æ•°
message LoginRequest {
	string username = 1;
  string password = 2;
}

// å“åº”ç»“æœ
message LoginResponse {
	string access_token = 1;
  int32 expires = 2;
}

// ç”¨æˆ·ç›¸å…³æ¥å£
service User {
	// ç™»å½•å‡½æ•°
	rpc login(LoginRequest) returns (LoginResponse);
}

```

ä¸ºäº†æ–¹é¢ç†è§£ï¼Œæˆ‘å°†ä¸Šé¢çš„å®šä¹‰ç¿»è¯‘ä¸º typescript å®šä¹‰ï¼š

```ts
namespace user {
  interface LoginRequest {
    username: string;
    password: string;
  }

  interface LoginResponse {
    access_token: string;
    expires: number;
  }

  interface User {
    login: (LoginRequest) => LoginResponse // ts ç±»å‹å®šä¹‰ä¸­ï¼Œå‡½æ•°å‚æ•°å¯ä»¥æ²¡æœ‰åç§°çš„ã€‚
  }
}
```

é€šè¿‡å¯¹æ¯”æˆ‘ä»¬çŸ¥é“ï¼š

*   syntax = "proto3"ï¼šè¿™å¥è¯ç›¸å½“äºç”¨ proto3 ç‰ˆæœ¬çš„åè®®ï¼Œç°åœ¨ç»Ÿä¸€çš„éƒ½æ˜¯ 3ï¼Œæ¯ä¸ª proto æ–‡ä»¶éƒ½è¿™æ ·å†™å°±å¯¹äº†
*   packageï¼šç±»ä¼¼ namespace ä½œç”¨åŸŸ
*   messageï¼šç›¸å½“äº ts ä¸­çš„ interface
*   serviceï¼šä¹Ÿæ˜¯ç›¸å½“äº js ä¸­çš„ interface
*   stringã€int32ï¼šåˆ†åˆ«æ˜¯ç±»å‹ï¼Œå› ä¸º ts ä¸­å…³äºæ•°çš„åˆ’åˆ†æ²¡é‚£ä¹ˆç»†ï¼Œæ‰€ä»¥ int32 å°±è¢«è½¬ä¸ºäº† number
*   Userï¼šç›¸å½“äº ts ä¸­çš„ç±»æˆ–è€…å¯¹è±¡
*   loginï¼šç›¸å½“äº ts ä¸­çš„æ–¹æ³•
*   æ•°å­— 1ã€2ï¼šæœ€ä»¤äººè¿·æƒ‘çš„å°±æ˜¯å˜é‡åçš„æ•°å­—äº†ï¼Œå®ƒå®é™…æ˜¯ grpc é€šä¿¡è¿‡ç¨‹çš„å…³é”®ï¼Œæ˜¯ç”¨äºæŠŠæ•°æ®ç¼–ç å’Œè§£ç çš„é¡ºåºï¼Œç±»ä¼¼äº json å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå†æŠŠå­—ç¬¦ä¸²è½¬ä¸º json å¯¹è±¡ä¸­é‚£äº›å†’å·å’Œé€—å·åˆ†å·çš„ä½œç”¨ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„è§„åˆ™ã€‚

ä» proto å®šä¹‰åˆ° node ä»£ç 
-------------------

### åŠ¨æ€åŠ è½½ç‰ˆæœ¬

æ‰€è°“åŠ¨æ€åŠ è½½ç‰ˆæœ¬æ˜¯æŒ‡åœ¨ nodejs å¯åŠ¨æ—¶åŠ è½½å¹¶å¤„ç† protoï¼Œç„¶åæ ¹æ® proto å®šä¹‰è¿›è¡Œæ•°æ®çš„ç¼–è§£ç ã€‚

*   åˆ›å»ºç›®å½•å’Œæ–‡ä»¶

gRPC æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº¤æ¢ä¿¡æ¯çš„æ¡†æ¶ï¼Œæˆ‘ä»¬å°±å»ºç«‹ä¸¤ä¸ª js æ–‡ä»¶åˆ†ä¸ºä½œä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯å‘é€ç™»å½•çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å“åº”ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```bash
.
â”œâ”€â”€ client.js # å®¢æˆ·ç«¯
â”œâ”€â”€ server.js # æœåŠ¡ç«¯
â”œâ”€â”€ user.proto # proto å®šä¹‰
â””â”€â”€ user_proto.js # å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½è¦ç”¨åˆ°åŠ è½½ proto çš„å…¬å…±ä»£ç 
```

*   å®‰è£…ä¾èµ–

```bash
yarn add @grpc/grpc-js  # @grpc/grpc-jsï¼šæ˜¯ gRPC node çš„å®ç°ï¼ˆä¸åŒè¯­è¨€æœ‰ä¸åŒè¯­è¨€çš„å®ç°ï¼‰
yarn add @grpc/proto-loader # @grpc/proto-loaderï¼šç”¨äºåŠ è½½ proto 
```

*   ç¼–å†™ user\_proto.js

`user_proto.js`å¯¹äºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å¾ˆé‡è¦ï¼Œå®¢æˆ·ç«¯å¯ä»¥çŸ¥é“è‡ªå·±è¦å‘é€çš„æ•°æ®ç±»å‹å’Œå‚æ•°ï¼Œè€ŒæœåŠ¡ç«¯å¯ä»¥çŸ¥é“è‡ªå·±æ¥å—çš„å‚æ•°ã€è¦å“åº”çš„ç»“æœä»¥åŠè¦å®ç°çš„å‡½æ•°åç§°ã€‚

```js
// user_proto.js
// åŠ è½½ proto
const path = require('path')
const grpc = require('@grpc/grpc-js')
const protoLoader = require('@grpc/proto-loader')

const PROTO_PATH = path.join(__dirname, 'user.proto') // proto è·¯å¾„
const packageDefinition = protoLoader.loadSync(PROTO_PATH, { keepCase: true, longs: String, enums: String, defaults: true, oneofs: true })
const protoDescriptor = grpc.loadPackageDefinition(packageDefinition)

const user_proto = protoDescriptor. user

module.exports = user_proto
```

*   ç¼–å†™ server.js

```js
// service.js
// æœåŠ¡ç«¯
const grpc = require("@grpc/grpc-js"); // å¼•å…¥ gprc æ¡†æ¶
const user_proto = require("./user_proto.js"); // åŠ è½½è§£æåçš„ proto

// User Service å®ç°
const userServiceImpl = {
  login: (call, callback) => {
    // call.request æ˜¯è¯·æ±‚ç›¸å…³ä¿¡æ¯
    const { request } = call;
    const { username, password } = request;

    // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å“åº”ç›¸å…³ä¿¡æ¯
    callback(null, {
      access_token: `username = ${username}; password = ${password}`,
      expires: "zhang",
    });
  },
};

// å’Œ http ä¸€æ ·ï¼Œéƒ½éœ€è¦å»ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç­‰å¾…åˆ«äººé“¾æ¥
function main() {
  const server = new grpc.Server(); // åˆå§‹åŒ– grpc æ¡†æ¶
  server.addService(user_proto.User.service, userServiceImpl); // æ·»åŠ  service
 	// å¼€å§‹ç›‘å¬æœåŠ¡ï¼ˆå›ºå®šå†™æ³•ï¼‰
  server.bindAsync("0.0.0.0:8081", grpc.ServerCredentials.createInsecure(), () => {
      server.start();
      console.log("grpc server started");
    }
  );
}

main();

```

å› ä¸º proto ä¸­æˆ‘ä»¬åªè¿›è¡Œäº†å®šä¹‰ï¼Œå¹¶æ²¡æœ‰ login çš„çœŸæ­£å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å† server.js ä¸­å¯¹ login è¿›è¡Œå®ç°ã€‚æˆ‘ä»¬å¯ä»¥ `console.log(user_proto)` çœ‹åˆ°ï¼š

```js
{
  LoginRequest: { 
  	// ... 
  },
  LoginResponse: {
  	// ...
  },
	User: [class ServiceClientImpl extends Client] {
    service: { login: [Object] }
  }
}
```

æ‰€ä»¥ `server.addService` æˆ‘ä»¬æ‰èƒ½å¡«å†™ `user_proto.User.service`ã€‚

*   ç¼–å†™ client.js

```js
// client.js
const user_proto = require("./user_proto");
const grpc = require("@grpc/grpc-js");

// ä½¿ç”¨ `user_proto.User` åˆ›å»ºä¸€ä¸ª clientï¼Œå…¶ç›®æ ‡æœåŠ¡å™¨åœ°å€æ˜¯ `localhost:8081`
// ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšåˆš service.js ç›‘å¬çš„åœ°å€
const client = new user_proto.User(
  "localhost:8081",
  grpc.credentials.createInsecure()
);

// å‘èµ·ç™»å½•è¯·æ±‚
function login() {
  return new Promise((resolve, reject) => {
      // çº¦å®šçš„å‚æ•°
      client.login(
        { username: 123, password: "abc123" },
        function (err, response) {
          if (err) {
            reject(err);
          } else {
            resolve(response);
          }
        }
      );
  })
}

async function main() {
  const res = await login();
  console.log(res)
}

main();
```

*   å¯åŠ¨æœåŠ¡

å…ˆ `node server.js` å¯åŠ¨æœåŠ¡ç«¯ï¼Œè®©å…¶ä¿æŒç›‘å¬ï¼Œç„¶å `node client.js` å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå‘é€è¯·æ±‚ã€‚

![image.png](/img/2023-12-10/01.png)

æˆ‘ä»¬çœ‹åˆ°å·²ç»æœ‰äº†å“åº”ç»“æœã€‚

*   **åå¿ƒçœ¼**

æˆ‘ä»¬ä½¿ä¸ªåå¿ƒçœ¼ï¼Œå¦‚æœå‘é€çš„æ•°æ®æ ¼å¼ä¸æ˜¯ proto ä¸­å®šä¹‰çš„ç±»å‹çš„ä¼šæ€ä¹ˆæ ·ï¼Ÿ ![image.png](/img/2023-12-10/02.png) ç­”æ¡ˆæ˜¯ä¼šè¢«**å¼ºåˆ¶ç±»å‹**è½¬æ¢ä¸º proto ä¸­å®šä¹‰çš„ç±»å‹ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ server.js ä¸­å°† expires å­—æ®µçš„è¿”å›å€¼æ”¹ä¸ºäº† `zhang` é‚£ä¹ˆä»–ä¼šè¢«è½¬ä¸ºæ•°å­— `0`ï¼Œè€Œå®¢æˆ·ç«¯å‘é€è¿‡å»çš„ `123` ä¹Ÿè¢«è½¬ä¸ºäº†å­—ç¬¦ä¸²ç±»å‹ã€‚

### é™æ€ç¼–è¯‘ç‰ˆæœ¬

åŠ¨æ€åŠ è½½æ˜¯è¿è¡Œæ—¶åŠ è½½ protoï¼Œè€Œé™æ€ç¼–è¯‘åˆ™æ˜¯æå‰å°† proto æ–‡ä»¶ç¼–è¯‘æˆ JS æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦åŠ è½½ js æ–‡ä»¶å°±è¡Œäº†ï¼Œçœå»äº†ç¼–è¯‘ proto çš„æ—¶é—´ï¼Œä¹Ÿæ˜¯åœ¨å·¥ä½œä¸­æ›´å¸¸è§çš„ä¸€ç§æ–¹å¼ã€‚

*   æ–°å»ºé¡¹ç›®

æˆ‘ä»¬æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œè¿™æ¬¡æ–‡ä»¶å¤¹å†…åªæœ‰å››ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºï¼š

```bash
.
â”œâ”€â”€ gen # æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾ç”Ÿæˆçš„ä»£ç 
â”œâ”€â”€ client.js # å®¢æˆ·ç«¯ä»£ç 
â”œâ”€â”€ server.js # æœåŠ¡ç«¯ä»£ç 
â””â”€â”€ user.proto # proto æ–‡ä»¶ï¼Œè®°å¾—å°†å†…å®¹æ‹·è´è¿‡æ¥
```

*   å®‰è£…ä¾èµ–

```bash
yarn global add grpc-tools # ç”¨äºä» proto -> js æ–‡ä»¶çš„å·¥å…·
yarn add google-protobuf @grpc/grpc-js # è¿è¡Œæ—¶çš„ä¾èµ–
```

*   ç”Ÿæˆ js ä»£ç 

```js
grpc_tools_node_protoc \
--js_out=import_style=commonjs,binary:./gen/ \
--grpc_out=grpc_js:./gen/ user.proto
```

æˆ‘ä»¬çœ‹åˆ°å·²ç»ç”Ÿæˆäº† `user_pb.js`å’Œ`user_grpc_pb.js` ä¸¤ä¸ªæ–‡ä»¶ï¼š

![image.png](/img/2023-12-10/03.png)

*   `grpc_tools_node_protoc`ï¼šæ˜¯å®‰è£… `grpc-tools` åç”Ÿæˆçš„å‘½ä»¤è¡Œå·¥å…·
*   `--js_out=import_style=commonjs,binary:./gen/`ï¼šæ˜¯ç”Ÿæˆ `user_pb.js` çš„å‘½ä»¤
*   `--grpc_out=grpc_js:./gen/`ï¼šæ˜¯ç”Ÿæˆ `user_grpc_pb.js` çš„å‘½ä»¤ã€‚

> pb æ˜¯ protobuf çš„ç®€å†™

å¦‚æœä½ å»ä»”ç»†æŸ¥çœ‹ä¸¤è€…çš„å†…å®¹ä½ å°±ä¼šå‘ç°ï¼š

user\_pb.jsï¼šä¸»è¦æ˜¯å¯¹ proto ä¸­çš„ `message` å®šä¹‰æ‰©å±•å„ç§ç¼–è§£ç æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¯¹ `LoginRequest`å’Œ `LoginResponse` åšå¤„ç†ã€‚

user\_grpc\_pb.jsï¼šåˆ™æ˜¯å¯¹ proto ä¸­çš„ `service` è¿›è¡Œå„ç§æ–¹æ³•å®šä¹‰ã€‚

*   ç¼–å†™ server.js

```js
const grpc = require("@grpc/grpc-js");

const services = require("./gen/user_grpc_pb");
const messages = require("./gen/user_pb");

const userServiceImpl = {
  login: (call, callback) => {
    const { request } = call;

    // ä½¿ç”¨ request é‡Œçš„æ–¹æ³•è·å–è¯·æ±‚çš„å‚æ•°
    const username = request.getUsername();
    const password = request.getPassword();

    // ä½¿ç”¨ message è®¾ç½®å“åº”ç»“æœ
    const response = new messages.LoginResponse();
    response.setAccessToken(`username = ${username}; password = ${password}`);
    response.setExpires(7200);

    callback(null, response);
  },
};

function main() {
  const server = new grpc.Server();

  // ä½¿ç”¨ services.UserService æ·»åŠ æœåŠ¡
  server.addService(services.UserService, userServiceImpl);
  server.bindAsync(
    "0.0.0.0:8081",
    grpc.ServerCredentials.createInsecure(),
    () => {
      server.start();
      console.log("grpc server started");
    }
  );
}

main();
```

æˆ‘ä»¬å‘ç°å’ŒåŠ¨æ€ç‰ˆçš„åŒºåˆ«å°±æ˜¯ `addService` æ—¶ç›´æ¥ä½¿ç”¨äº†å¯¼å‡ºçš„ `UserService` å®šä¹‰ï¼Œç„¶åå†å®ç° login æ—¶ï¼Œæˆ‘ä»¬èƒ½ä½¿ç”¨å„ç§å°è£…çš„æ–¹æ³•æ¥å¤„ç†è¯·æ±‚å’Œå“åº”å‚æ•°ã€‚

*   ç¼–å†™ client.js

```js
// client.js

const grpc = require("@grpc/grpc-js");

const services = require("./gen/user_grpc_pb");
const messages = require("./gen/user_pb");

// ä½¿ç”¨ services åˆå§‹åŒ– Client
const client = new services.UserClient(
  "localhost:8081",
  grpc.credentials.createInsecure()
);

// å‘èµ· login è¯·æ±‚
function login() {
  return new Promise((resolve, reject) => {
    // ä½¿ç”¨ message åˆå§‹åŒ–å‚æ•°
    const request = new messages.LoginRequest();
    request.setUsername("zhang");
    request.setPassword("123456");

    client.login(request, function (err, response) {
      if (err) {
        reject(err);
      } else {
        resolve(response.toObject());
      }
    });
  });
}

async function main() {
  const res = await login()
  console.log(res)
}

main();
```

ä»ä¸Šé¢çš„æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ç›´æ¥ä»ç”Ÿæˆçš„ JS æ–‡ä»¶ä¸­åŠ è½½å†…å®¹ï¼Œå¹¶ä¸”å®ƒæä¾›äº†å¾ˆå¤šå°è£…çš„æ–¹æ³•ï¼Œè®©æˆ‘ä»¬ä¼ å‚æ›´åŠ å¯æ§ã€‚

ä» JS åˆ° TS
---------

ä»ä¸Šé¢æˆ‘ä»¬ä¹Ÿçœ‹å‡ºäº†ï¼Œå¯¹äºå‚æ•°ç±»å‹çš„é™åˆ¶ï¼Œæ›´å¤šæ˜¯å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œåœ¨ä¹¦å†™é˜¶æ®µå¹¶ä¸èƒ½å‘ç°ï¼Œè¿™å°±å¾ˆä¸ç§‘å­¦äº†ï¼Œä¸è¿‡ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ proto ç”Ÿæˆ ts ç±»å‹å®šä¹‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ç½‘ä¸Šå…³äºä» proto åˆ°ç”Ÿæˆ ts çš„æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä½¿ç”¨ `protoc` + `grpc_tools_node_protoc_ts` + `grpc-tools` ã€‚

*   æ–°å»ºé¡¹ç›®

```bash
mkdir grpc_demo_ts && cd grpc_demo_ts # åˆ›å»ºé¡¹ç›®ç›®å½•

yarn global add typescript ts-node @types/node # å®‰è£… ts å’Œ ts-node

tsc --init # åˆå§‹åŒ– ts
```

*   å®‰è£… proto å·¥å…·

```bash
yarn global add grpc-tools grpc_tools_node_protoc_ts # å®‰è£… proto å·¥å…·åˆ°å…¨å±€
```

*   å®‰è£…è¿è¡Œæ—¶ä¾èµ–

```bash
yarn add google-protobuf @grpc/grpc-js # è¿è¡Œæ—¶ä¾èµ–
```

*   åˆ›å»ºæ–‡ä»¶

```bash
mkdir gen # åˆ›å»ºå­˜æ”¾è¾“å‡ºæ–‡ä»¶çš„ç›®å½•
touch client.ts server.ts user.proto # åˆ›å»ºæ–‡ä»¶
# è®°å¾—æŠŠ user.proto çš„å†…å®¹æ‹·è´è¿‡å»
```

*   å®‰è£… `protoc`

ç„¶åæˆ‘ä»¬éœ€è¦å®‰è£… `protoc` è¿™ä¸ªå·¥å…·ï¼Œé¦–å…ˆè¿›å…¥ protobuf çš„ [github](https://github.com/protocolbuffers/protobuf)ï¼Œè¿›å…¥ [release](https://github.com/protocolbuffers/protobuf/releases)ï¼Œä¸‹è½½æ‰€åœ¨å¹³å°çš„æ–‡ä»¶ï¼Œç„¶åè¿›è¡Œå®‰è£…ï¼Œå®‰è£…å®Œè®°å¾—æŠŠå…¶åŠ å…¥åˆ°è®¾ç½®ç¯å¢ƒå˜é‡é‡Œï¼Œç¡®ä¿å¯ä»¥å…¨å±€ä½¿ç”¨ã€‚

![image.png](/img/2023-12-10/04.png)

> mac å¯ä»¥é€šè¿‡ `brew install protobuf` è¿›è¡Œå®‰è£…ï¼Œå®‰è£…åå…¨å±€å°±ä¼šæœ‰ protoc å‘½ä»¤

*   ç”Ÿæˆ js æ–‡ä»¶å’Œ ts ç±»å‹å®šä¹‰

```bash
# ç”Ÿæˆ user_pb.js å’Œ user_grpc_pb.js
grpc_tools_node_protoc \
--js_out=import_style=commonjs,binary:./gen \
--grpc_out=grpc_js:./gen \
--plugin=protoc-gen-grpc=`which grpc_tools_node_protoc_plugin` \
./user.proto

# ç”Ÿæˆ d.ts å®šä¹‰
protoc \
--plugin=protoc-gen-ts=`which protoc-gen-ts` \
--ts_out=grpc_js:./gen \
./user.proto
``` 

*   ç¼–å†™ server.ts

```ts
// server.ts

import * as grpc from "@grpc/grpc-js";
import { IUserServer, UserService } from "./gen/user_grpc_pb";
import messages from "./gen/user_pb";

// User Service çš„å®ç°
const userServiceImpl: IUserServer = {
  // å®ç°ç™»å½•æ¥å£
  login(call, callback) {
    const { request } = call;
    const username = request.getUsername();
    const password = request.getPassword();

    const response = new messages.LoginResponse();
    response.setAccessToken(`username = ${username}; password = ${password}`);
    response.setExpires(7200);
    callback(null, response);
  }
}

function main() {
  const server = new grpc.Server();
  
  // UserService æ˜¯å®šä¹‰ï¼ŒUserImpl æ˜¯å®ç°
  server.addService(UserService, userServiceImpl);
  server.bindAsync(
    "0.0.0.0:8081",
    grpc.ServerCredentials.createInsecure(),
    () => {
      server.start();
      console.log("grpc server started");
    }
  );
}

main();
```

![image.png](/img/2023-12-10/05.png)

ç±»å‹æç¤ºå¾ˆå®Œç¾ ğŸ˜„

*   ç¼–å†™ client.ts

```ts
// client.ts

import * as grpc from "@grpc/grpc-js";
import { UserClient } from "./gen/user_grpc_pb";
import messages from "./gen/user_pb";

const client = new UserClient(
  "localhost:8081",
  grpc.credentials.createInsecure()
);

// å‘èµ·ç™»å½•è¯·æ±‚
const login = () => {
  return new Promise((resolve, reject) => {
    const request = new messages.LoginRequest();
    request.setUsername('zhang');
    request.setPassword("123456");

    client.login(request, function (err, response) {
      if (err) {
        reject(err);
      } else {
        resolve(response.toObject());
      }
    });
  })
}

async function main() {
  const data = await login()
  console.log(data)
}

main();
```

![image.png](/img/2023-12-10/06.png) å½“æˆ‘ä»¬è¾“å…¥é”™ç±»å‹æ—¶ï¼Œts å°±ä¼šè¿›è¡Œå¼ºåˆ¶æ£€éªŒã€‚

*   å¯åŠ¨æœåŠ¡

![image.png](/img/2023-12-10/07.png)

æˆ‘ä»¬ä½¿ç”¨ `ts-node` å¯åŠ¨ä¸¤è€…ï¼Œå‘ç°æ•ˆæœä¸€èµ·æ­£å¸¸ã€‚

ä» Node åˆ° Go
-----------

ä¸Šé¢çš„ä»‹ç»ä¸­ï¼Œclient å’Œ server éƒ½æ˜¯ç”¨ js/ts æ¥å†™çš„ï¼Œä½†å®é™…å·¥ä½œä¸­æ›´å¤šçš„æ˜¯ node ä½œä¸ºå®¢æˆ·ç«¯å»èšåˆè°ƒå…¶ä»–è¯­è¨€å†™çš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸è¯´çš„ BFF å±‚ï¼Œæˆ‘ä»¬ä»¥ go è¯­è¨€ä¸ºä¾‹ã€‚

*   æ”¹é€ åŸ ts é¡¹ç›®

æˆ‘ä»¬å°†ä¸Šé¢çš„ ts é¡¹ç›®æ”¹é€ ä¸º client å’Œ server ä¸¤ä¸ªç›®å½•ï¼Œclient æ˜¯ ts é¡¹ç›®ä½œä¸ºå®¢æˆ·ç«¯ï¼Œserver æ˜¯ go é¡¹ç›®ï¼Œä½œä¸ºæœåŠ¡ç«¯ï¼ŒåŒæ—¶æˆ‘ä»¬æŠŠåŸæ¥çš„ server.ts åˆ é™¤ï¼ŒæŠŠ user.proto æ”¾åˆ°æœ€å¤–é¢ï¼Œä¸¤è€…å…±ç”¨ã€‚

```bash
.
â”œâ”€â”€ client # å®¢æˆ·ç«¯æ–‡ä»¶å¤¹ï¼Œå…¶å†…å®¹åŒ ts ç« èŠ‚ï¼Œåªæ˜¯åˆ é™¤äº† server.ts ç›¸å…³å†…å®¹
â”‚   â”œâ”€â”€ client.ts
â”‚   â”œâ”€â”€ gen
â”‚   â”‚   â”œâ”€â”€ user_grpc_pb.d.ts
â”‚   â”‚   â”œâ”€â”€ user_grpc_pb.js
â”‚   â”‚   â”œâ”€â”€ user_pb.d.ts
â”‚   â”‚   â””â”€â”€ user_pb.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ yarn.lock
â”œâ”€â”€ server # æœåŠ¡ç«¯æ–‡ä»¶
â””â”€â”€ user.proto # proto æ–‡ä»¶
```

*   å®‰è£… Go

æˆ‘ä»¬è¿›å…¥ Go è¯­è¨€å®˜ç½‘ï¼Œæ‰¾åˆ°æœ€æ–°çš„ç‰ˆæœ¬ä¸‹è½½å®‰è£…å³å¯ï¼š[golang.google.cn/dl/](https://golang.google.cn/dl/)

*   è®¾ç½® go ä»£ç†

å’Œ npm ä¸€æ ·ï¼Œgo è¯­è¨€æ‹‰åŒ…ï¼Œä¹Ÿéœ€è¦è®¾ç½®é•œåƒæ‹‰åŒ…æ‰èƒ½æ›´å¿«ã€‚

```bash
go env -w GOPROXY=https://goproxy.cn,direct
```

*   åˆå§‹åŒ– go é¡¹ç›®

ç±»ä¼¼ yarn init -y çš„ä½œç”¨ã€‚

```bash
cd server # è¿›å…¥ server ç›®å½•
go mod init grpc_go_demo # åˆå§‹åŒ–åŒ…
mkdir -p gen/user # ç”¨äºå­˜æ”¾åé¢ç”Ÿæˆçš„ä»£ç 
```

*   å®‰è£… protoc çš„ go è¯­è¨€æ’ä»¶

ç”¨äºç”Ÿæˆ go è¯­è¨€çš„ä»£ç ï¼Œä½œç”¨ä¸ `grpc-tools` å’Œ `grpc_tools_node_protoc_ts` ç›¸åŒã€‚

```bash
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.26
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.1 
```

*   å®‰è£…è¿è¡Œæ—¶ä¾èµ–

æˆ‘ä»¬è¿˜éœ€è¦å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼Œä½œç”¨ç±»ä¼¼ä¸Šé¢ node çš„ `google-protobuf` å’Œ `@grpc/grpc-js`ã€‚

```bash
go get -u github.com/golang/protobuf/proto
go get -u google.golang.org/grpc
```

*   ä¿®æ”¹ user.proto

```protobuf
syntax = "proto3";

option go_package = "grpc_go_demo/gen/user"; // å¢åŠ è¿™ä¸€å¥

package user;

message LoginRequest {
	string username = 1;
  string password = 2;
}

message LoginResponse {
	string access_token = 1;
  int32 expires = 2;
}

service User {
	rpc login(LoginRequest) returns (LoginResponse);
}
``` 

*   ç”Ÿæˆ go ä»£ç 

```bash
// è¦åœ¨ server ç›®å½•å“¦

protoc --go_out=./gen/user -I=../ --go_opt=paths=source_relative \
    --go-grpc_out=./gen/user -I=../ --go-grpc_opt=paths=source_relative \
    ../user.proto
```

*   å®‰è£… VS Code æ’ä»¶å¹¶æ–°åˆ›å»ºæ‰“å¼€é¡¹ç›®

å½“ä½ ç‚¹å‡»å»æŸ¥çœ‹ç”Ÿæˆå‡ºæ¥çš„ `user.pb.go` æˆ–è€… `user_grpc.pb.go` æ—¶ï¼Œä½ ä¼šå‘ç° vscode è®©ä½ è£…æ’ä»¶ï¼Œè£…å°±å®Œäº‹äº†ï¼Œç„¶åä½ å¯èƒ½ä¼šå‘ç° go åŒ…æŠ¥æ‰¾ä¸åˆ°çš„é”™è¯¯ï¼Œä¸è¦æ…Œï¼Œæˆ‘ä»¬ä»¥ server ä¸ºé¡¹ç›®æ ¹è·¯å¾„é‡æ–°æ‰“å¼€é¡¹ç›®å³å¯ã€‚

*   åˆ›å»º main.go ä¹¦å†™æœåŠ¡ç«¯ä»£ç 

```go
// server/main.go

package main

import (
	"context"
	"fmt"
	pb "grpc_go_demo/gen/user"
	"log"
	"net"

	"google.golang.org/grpc"
)

// å£°æ˜ä¸€ä¸ªå¯¹è±¡
type userServerImpl struct {
	pb.UnimplementedUserServer
}

// å¯¹è±¡æœ‰ä¸€ä¸ª Login æ–¹æ³•
func (s *userServerImpl) Login(ctx context.Context, in *pb.LoginRequest) (*pb.LoginResponse, error) {
	// è¿”å›å“åº”ç»“æœ
    return &pb.LoginResponse{
		AccessToken: fmt.Sprintf("go: username = %v, password = %v", in.GetUsername(), in.GetPassword()),
		Expires: 7200,
	}, nil
}


// ç›‘å¬æœåŠ¡å¹¶å°† server å¯¹è±¡æ³¨å†Œåˆ° gRPC æœåŠ¡å™¨ä¸Š
func main() {
    // åˆ›å»º tcp æœåŠ¡
	lis, _ := net.Listen("tcp", ":8081")
	
    // åˆ›å»º grpc æœåŠ¡
	server := grpc.NewServer()
    
    // å°† UserServer æ³¨å†Œåˆ° server
	pb.RegisterUserServer(server, &userServerImpl{})
    
	log.Printf("server listening at %v", lis.Addr())

	if err := s.Serve(lis); err != nil {
		log.Fatalf("failed to serve: %v", err)
	}
}
```

![image.png](/img/2023-12-10/08.png)

ä¸ºä»€ä¹ˆæ˜¯ gRPC è€Œé HTTP?
------------------

ç°åœ¨å¾®æœåŠ¡æ¶æ„å¤§å¤šæ•°ä½¿ç”¨çš„æ˜¯ gRPC è¿›è¡ŒæœåŠ¡é—´é€šä¿¡ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸å†ä½¿ç”¨æˆ‘ä»¬å‰ç«¯ç†Ÿæ‚‰çš„ http å‘¢ï¼Ÿ

æœ‰äººè¯´é«˜æ•ˆç‡ï¼ŒgRPC æ˜¯ `tcp` åè®®ã€äºŒè¿›åˆ¶ä¼ è¾“ï¼Œæ•ˆç‡é«˜ï¼Œæ•ˆç‡é«˜ç¼ºå¤±æ²¡é”™ï¼Œä½†å®ƒç›¸å¯¹äº http å¹¶ä¸ä¼šæœ‰æ˜æ˜¾çš„å·®è·ï¼Œä¸€æ–¹é¢ http ä¸­ json ç¼–è§£ç æ•ˆç‡å’Œå ç”¨ç©ºé—´æ•°å¹¶ä¸ä¼šæ¯”ç¼–è§£æˆäºŒè¿›åˆ¶å·®å¤šå°‘ï¼Œå…¶æ¬¡ï¼Œtcp å’Œ http åœ¨å†…ç½‘ç¯å¢ƒä¸‹ï¼Œå¸¦æ¥çš„æ€§èƒ½æˆ‘ä¸ªäººæ„Ÿè§‰ä¹Ÿä¸ä¼šå·®å¤šå°‘ï¼ˆPSï¼šgRPC å®˜ç½‘ä¹Ÿå¹¶æœªå¼ºè°ƒå®ƒç›¸å¯¹äº HTTP çš„é«˜æ•ˆç‡ï¼‰ã€‚

å…¶å®å®˜ç½‘æ ¸å¿ƒçªå‡ºçš„å°±åœ¨äºå®ƒçš„**è¯­è¨€æ— å…³æ€§**ï¼Œé€šè¿‡ protobuf è¿™ç§ä¸­é—´å½¢å¼ï¼Œå¯ä»¥è½¬æ¢ä¸ºå„ç§è¯­è¨€çš„ä»£ç ï¼Œç¡®ä¿äº†ä»£ç çš„ä¸€è‡´æ€§ï¼Œè€Œé http é‚£æ ·å¯¹ç€ swagger æˆ–è€…å…¶ä»–çš„æ–‡æ¡£å¹³å°å»å¯¹æ¥å£ã€‚

ç»“æŸè¯­
---

æœ¬ç¯‡åªæ˜¯ä¸€ä¸ªå…¥é—¨ï¼Œè‡³äº gRPC å¦‚ä½•ç»“åˆ node æ¡†æ¶è¿›è¡Œå¼€å‘æˆ–è€…æ›´æ·±çš„çŸ¥è¯†è¿˜éœ€è¦è¯¸å›è‡ªå·±å»æ‘¸ç´¢ã€‚